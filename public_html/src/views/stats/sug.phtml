<?php iterateUsers(function($user, $otherUser) { ?>
<div class="section recs">
	<h2>
		<i data-tooltip="List of titles you might want to check out we found using some complicated formulas." class="icon-tooltip"></i>
		<?php echo ChibiRegistry::getHelper('mg')->headerLink($user, 'recommendations') ?>
	</h2>
	<div class="section-body">
		<?php if (empty($this->recs[$user->getID()])): ?>
			<p>No recommendations. :(</p>
		<?php else: ?>
			<?php if ($this->recsStatic): ?>
				<p>Your <?php echo ChibiRegistry::getHelper('mg')->amText() ?> list is too short for us to properly guess your tastes.<br>
				Here you have some widely recommended titles that you haven&rsquo;t <?php echo $this->am == AMModel::TYPE_ANIME ? 'seen' : 'watched' ?> yet:</p>
			<?php endif ?>
			<ol>
			<?php foreach ($this->recs[$user->getID()] as $entry): ?>
				<li>
					<a href="http://myanimelist.net/<?php echo ChibiRegistry::getHelper('mg')->amText() ?>/<?php echo $entry->getID() ?>">
						<?php echo $entry->getTitle() ?>
					</a>
				</li>
			<?php endforeach ?>
			</ol>
		<?php endif ?>
	</div>
</div>
<?php }); ?>



<?php iterateUsers(function($user, $otherUser) { ?>
<div class="section missing">
	<h2>
		<i data-tooltip="List of titles related to those you|have completed, sorted by score." class="icon-tooltip"></i>
		<?php echo ChibiRegistry::getHelper('mg')->headerLink($user, 'missing titles') ?>
	</h2>
	<div class="section-body">

		<?php if (empty($this->relations[$user->getID()])): ?>
			<p>Yay! No missing relations!</p>
		<?php elseif ($user->getList($this->am)->isPrivate()): ?>
			<p>Since <?php echo $user->getPublicName() ?>&rsquo;s <?php echo $this->mgHelper->amText() ?> list is marked as private, we can&rsquo;t reveal its content by showing suggestions.<br>
			If this is your list, click <a href="http://myanimelist.net/editprofile.php?go=listpreferences">here</a> to change privacy settings.</p>
		<?php else: ?>

			<table>
				<thead>
					<tr>
						<th class="subject">You've <?php echo $this->am == AMModel::TYPE_ANIME ? 'watched' : 'read' ?> this&hellip;</th>
						<th class="proposed">&hellip;so you might want to check this:</th>
					</tr>
				</thead>
				<?php foreach ($this->relations[$user->getID()] as $franchise): ?>
					<tbody>
						<tr data-ids="<?php echo join(' ', array_map(function($entry) { return $entry->getID(); }, $franchise->ownEntries)) ?>">
							<td class="subject">
								<ul>
								<?php foreach ($franchise->ownEntries as $entry): ?>
									<li data-id="<?php echo $entry->getID() ?>">
										<a href="http://myanimelist.net/<?php echo $this->mgHelper->amText() ?>/<?php echo $entry->getID() ?>">
											<?php echo htmlspecialchars($entry->getAMEntry()->getTitle()) ?>
										</a>
									</li>
								<?php endforeach ?>
								</ul>
							</td>
							<td class="proposed">
								<ul>
									<?php foreach ($franchise->entries as $entry): ?>
										<?php if (!$entry->isValid()): ?>
											<?php continue ?>
										<?php else: ?>
											<li data-id="<?php echo $entry->getID() ?>">
												<a href="http://myanimelist.net/<?php echo $this->mgHelper->amText() ?>/<?php echo $entry->getID() ?>">
													<?php echo htmlspecialchars($entry->getTitle()) ?>
												</a>
											</li>
										<?php endif ?>
									<?php endforeach ?>
								</ul>
							</td>
						</tr>
					</tbody>
				<?php endforeach ?>
			</table>
		<?php endif ?>

	</div>
</div>
<?php }); ?>



<script type="text/javascript">
	$('.missing tr').each(function() {
		var num1 = 8;
		var num2 = 5;

		var tr = $(this);
		var ul = tr.find('ul');
		var doCollapse = false;
		ul.each(function() {
			var li = $(this).children('li');
			if (li.length > num1) {
				doCollapse = true;
			}
		});

		if (doCollapse) {
			ul.each(function() {
				var ul2 = $('<ul class="expand"/>');
				$(this).find('li').each(function(i) {
					if (i > num2) {
						ul2.append($(this));
					}
				});
				ul2.insertAfter($(this)).hide();
			});
			var newTr = $('<tr><td colspan="2"/></tr>');
			var link = $('<a class="more" href="#">(more)</a>').click(function(e) {
				e.preventDefault();
				tr.find('.expand').slideDown(function() {
					link.slideUp();
				});
			});
			newTr.insertAfter(tr).find('td').append(link);
		}
	});
</script>
