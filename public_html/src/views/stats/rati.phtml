<div class="section">
	<h2>
		<a href="<?php echo $this->mgHelper->constructUrl(null, null, [], $this->user['link-name']) ?>">
			<?php echo $this->user['visible-name'] ?>
		</a>
		&rsquo;s <?php echo $this->mgHelper->amText() ?> rating statistics
	</h2>
</div>



<div class="section score-dist">
	<h3>
		<i data-title="Count of all entries scored with given rating, in a bar chart form" class="tooltipable icon-tooltip"></i>
		Rating distribution
	</h3>
	<div class="section-body">
		<?php if ($this->user[$this->am]['score-info']['rated'] == 0): ?>
			<p>This user doesn&rsquo;t seem to have anything rated. No chart here.</p>
		<?php else: ?>
			<ul class="infobox">
				<li>
					<div>
						<span class="prefix">Total rated</span>
						<span class="subject"><?php printf('%d', $this->user[$this->am]['score-info']['rated']) ?></span>
					</div>
				</li>
				<li>
					<div>
						<span class="prefix">Mean score</span>
						<span class="subject"><?php printf('%.02f', $this->user[$this->am]['score-info']['mean-score']) ?></span>
					</div>
				</li>
				<li>
					<div>
						<span class="prefix">Std dev</span>
						<span class="subject"><?php printf('%.02f', $this->user[$this->am]['score-info']['std-dev']) ?></span>
					</div>
				</li>
				<li>
					<button class="btn export-trigger">Export</button>
				</li>
			</ul>

			<div class="wrapper wrapper-target">
				<div class="target"></div>
				<div class="clear"></div>
			</div>

			<div class="wrapper wrapper-more">
				<div class="more export">
					<p>You can export your rating distribution as an image, which updates automatically every 24h. How about putting it on your MAL profile?</p>
					<div class="wrapper">
						<div class="header">
							<select name="type"></select>
							<select name="theme"></select>
							<a target="_blank" class="btn export-show" href="#">Show</a>
							<div class="clear"></div>
						</div>
						<textarea name="bbcode">[center][url=http://<?php echo $_SERVER['SERVER_NAME'] ?>/<?php echo $this->user['link-name'] ?>][img]http://<?php echo $_SERVER['SERVER_NAME'] ?>/export/<?php echo $this->user['link-name'] ?>?type=1[/img][/url][/center]</textarea>
					</div>
				</div>

				<?php foreach ($this->user[$this->am]['score-info']['dist-entries'] as $score => $entries): ?>
					<div class="more" data-id="<?php echo $score ?>">
						<?php if ($score == 0): ?>
							<p>Unrated titles:</p>
						<?php else: ?>
							<p>Titles rated with <?php echo $score ?>:</p>
						<?php endif ?>
						<?php if (empty($entries)): ?>
							<?php if ($score == 0): ?>
								<p>Horray! No unrated titles.</p>
							<?php else: ?>
								<p>None!</p>
							<?php endif ?>
						<?php elseif ($this->user[$this->am]['private']): ?>
							<p>This list is private.</p>
						<?php else: ?>
							<ul>
								<?php foreach ($entries as $e): ?>
									<li>
										<a href="http://myanimelist.net/<?php echo $this->mgHelper->amText() ?>/<?php echo $e['full']['id'] ?>">
											<?php echo $e['full']['title'] ?>
										</a>
										&nbsp;(
										<?php echo $this->mgHelper->subTypeText($e['full']['sub-type']) ?>
										<?php if ($e['full']['sub-type'] != AnimeModel::ENTRY_SUBTYPE_MOVIE): ?>
											,&nbsp;
											<?php if ($this->am == AMModel::ENTRY_TYPE_MANGA): ?>
												<?php echo $e['full']['volumes'] ?>&nbsp;
												<?php if ($e['full']['volumes'] == 1): ?>
													vol
												<?php else: ?>
													vols
												<?php endif ?>
											<?php else: ?>
												<?php echo $e['full']['episodes'] ?>&nbsp;
												<?php if ($e['full']['episodes'] == 1): ?>
													ep
												<?php else: ?>
													eps
												<?php endif ?>
											<?php endif ?>
										<?php endif ?>
										)
									</li>
								<?php endforeach ?>
							</ul>
						<?php endif ?>
					</div>
				<?php endforeach ?>
			</div>

			<script type="text/javascript">
				$('#user-<?php echo $this->user['user-safe-id'] ?> .score-dist .target').each(function() {
					var chart = new Highcharts.Chart({
						chart: { renderTo: this, type: 'bar', marginRight: 35 },
						xAxis: { categories: <?php echo json_encode(array_map(function($x) { return $x == 0 ? '-' : $x; }, array_keys($this->user[$this->am]['score-info']['dist-score']))) ?>, title: { text: 'Rating' } },
						yAxis: { title: { text: 'Count', margin: 15 } },
						tooltip: { formatter: function() {
							var text;
							if (this.x == '-') {
								text = 'Unrated titles: ' + this.y;
							} else {
								text = 'Titles rated with ' + this.x + ': ' + this.y;
							}
							var percent = this.y * 100.0 / <?php echo max(1, $this->user[$this->am]['score-info']['rated'] + $this->user[$this->am]['score-info']['unrated']) ?>;
							text = text + ' (' + (Math.round(percent * 100.0) / 100.0) + '%)';
							return text;
						} },
						series: [ {
							data: <?php echo json_encode(array_values($this->user[$this->am]['score-info']['dist-score'])) ?>,
							point: { events: { click: function(e) {
								var x = this.category;
								if (x == '-') {
									x = 0;
								}
								$('.export-trigger').removeClass('active');
								toggleWithinSections($('.score-dist .more[data-id=' + x + ']'), true);
							} } }
						} ]
					});
				});
			</script>
		<?php endif ?>
	</div>
</div>



<div class="section score-time-dist">
	<h3>
		<i data-title="How much time have you spent on titles rated with given score?" class="tooltipable icon-tooltip"></i>
		Rating to time distribution
	</h3>
	<div class="section-body">
		<?php if ($this->user[$this->am]['score-info']['rated'] == 0): ?>
			<p>This user doesn&rsquo;t seem to have anything rated. No chart here.</p>
		<?php else: ?>
			<ul class="infobox">
				<li>
					<div>
						<span class="prefix">Total time</span>
						<span class="subject"><?php printf('%.02f', ($this->user[$this->am]['score-info']['rated-total-time'] + $this->user[$this->am]['score-info']['unrated-total-time']) / 24.0) ?></span>
						<span class="suffix">days</span>
					</div>
				</li>
				<li>
					<div>
						<span class="prefix">Mean score</span>
						<span class="subject"><?php printf('%.02f', $this->user[$this->am]['score-info']['mean-time']) ?></span>
						<span class="suffix">(weighted)</span>
					</div>
				</li>
			</ul>

			<div class="wrapper wrapper-target">
				<div id="target-score-time-dist-<?php echo $this->user['user-safe-id'] ?>" class="target"></div>
				<div class="clear"></div>
			</div>

			<div class="wrapper wrapper-more">
				<?php foreach ($this->user[$this->am]['score-info']['dist-entries'] as $score => $entries): ?>
					<div class="more" data-id="<?php echo $score ?>">
						<?php if ($score == 0): ?>
							<p>Unrated titles:</p>
						<?php else: ?>
							<p>Titles rated with <?php echo $score ?>:</p>
						<?php endif ?>
						<?php if (empty($entries)): ?>
							<?php if ($score == 0): ?>
								<p>Horray! No unrated titles.</p>
							<?php else: ?>
								<p>None!</p>
							<?php endif ?>
						<?php elseif ($this->user[$this->am]['private']): ?>
							<p>This list is private.</p>
						<?php else: ?>
							<ul>
								<?php foreach ($entries as $e): ?>
									<li>
										<a href="http://myanimelist.net/<?php echo $this->mgHelper->amText() ?>/<?php echo $e['full']['id'] ?>">
											<?php echo $e['full']['title'] ?>
										</a>
										&nbsp;(<?php echo $e['user']['total-time'] ?> min.)
									</li>
								<?php endforeach ?>
							</ul>
						<?php endif ?>
					</div>
				<?php endforeach ?>
			</div>

			<script type="text/javascript">
				$('#user-<?php echo $this->user['user-safe-id'] ?> .score-time-dist .target').each(function() {
					var chart = new Highcharts.Chart({
						chart: { renderTo: this, type: 'bar', marginRight: 15 },
						xAxis: { categories: <?php echo json_encode(array_map(function($x) { return $x == 0 ? '-' : $x; }, array_keys($this->user[$this->am]['score-info']['dist-time']))) ?>, title: { text: 'Rating' } },
						yAxis: { title: {text: 'Hours spent', margin: 15 } },
						tooltip: { formatter: function() {
							var text;
							if (this.x == '-') {
								text = 'Hours spent on unrated titles: ' + Math.round(this.y * 100) / 100.0;
							} else {
								text = 'Hours spent on titles rated with ' + this.x + ': ' + Math.round(this.y * 100) / 100.0;
							}
							var percent = this.y * 100.0 / <?php echo max(1, $this->user[$this->am]['score-info']['rated-total-time'] + $this->user[$this->am]['score-info']['unrated-total-time']) ?>;
							text = text + ' (' + (Math.round(percent * 100.0) / 100.0) + '%)';
							return text
						} },
						series: [ {
							data: <?php echo json_encode(array_values($this->user[$this->am]['score-info']['dist-time'])) ?>,
							point: { events: { click: function(e) {
								var x = this.category;
								if (x == '-') {
									x = 0;
								}
								toggleWithinSections($('.score-time-dist .more[data-id=' + x + ']'), true);
							} } }
						} ]
					});
				});
			</script>
		<?php endif ?>
	</div>
</div>



<?php if ($this->isFinal): ?>
	<script type="text/javascript">
		$(function() {
			$('.export-trigger').click(function(e) {
				e.preventDefault();
				toggleWithinSections($(this).parents('.section').find('.more.export'), true);
				$(this).toggleClass('active');
			});

			var types =
			[
				{ 'type': 1, 'name': 'Anime' },
				{ 'type': 2, 'name': 'Manga' },
				{ 'type': 3, 'name': 'Anime & manga' },
			];
			$('select[name=\'type\']').each(function() {
				for (var i in types) {
					$(this).append($('<option/>').text(types[i]['name']).data('type', types[i]['type']));
				}
				$(this).change(function() {
					var textarea = $(this).parents('.export').find('textarea');
					var type = $(this).find('option:selected').data('type');
					textarea.text(textarea.text().replace(/(type=[0-9]*)/, 'type=' + type));
				});
			});

			var themes =
			[
				{ 'params': { }, 'name': 'Blue (default)' },
				{ 'params': { 'bar1': '00ffaaaa', 'bar2': '00ee6677', 'line1': 'c0ffaaaa', 'line2': 'c0ee6677', 'back': 'ffffffff', 'font1': '20442233', 'font2': '85aa4444', 'title': '00cc5566', 'hue': 330 }, 'name': 'Pink' },
				{ 'params': { 'bar1': '0044ff44', 'bar2': '00008800', 'line1': 'dd44ff44', 'line2': 'dd00aa00', 'back': 'ffffffff', 'font1': '20227722', 'font2': '90227722', 'title': '00227722', 'hue': 100 }, 'name': 'Green' },
				{ 'params': { 'bar1': '00eecc05', 'bar2': '00dd2200', 'line1': 'aaffdd00', 'line2': 'aaff0000', 'back': 'ffffffff', 'font1': '20220700', 'font2': '90220700', 'title': '00220700', 'hue': 45  }, 'name': 'Flame (yellow + red)' },
				{ 'params': { 'bar1': 'aa000000', 'bar2': '33000000', 'line1': 'ff000000', 'line2': 'dd000000', 'back': 'ffffffff', 'font1': '20000000', 'font2': '90000000', 'title': '20000000', 'hue': 218 }, 'name': 'Gray' },
				{ 'params': { 'bar1': '0084a0d4', 'bar2': '0003359a', 'line1': '00446084', 'line2': '0001156a', 'back': '00000000', 'font1': '00779fe2', 'font2': '50779fe2', 'title': '00779fe2', 'hue': 218 }, 'name': 'unBlue (blue on black)' },
				{ 'params': { 'bar1': '0044ff44', 'bar2': '00008800', 'line1': '00004400', 'line2': '00008800', 'back': '00000000', 'font1': '2044ff44', 'font2': '00008800', 'title': '0033aa33', 'hue': 100 }, 'name': 'Matrix (green on black)' },
			];
			$('select[name=\'theme\']').each(function() {
				for (var i in themes) {
					$(this).append($('<option/>').text(themes[i]['name']).data('params', themes[i]['params']));
				}
				$(this).change(function() {
					var textarea = $(this).parents('.export').find('textarea');
					var params = $(this).find('option:selected').data('params');
					var merged = '';
					for (key in params) {
						merged += '&' + key + '=' + params[key];
					}
					textarea.text(textarea.text().replace(/(type=[0-9]*).*?\[/, '$1' + merged + '['));
				});
			});

			$('.more.export textarea').click(function() {
				$(this).select();
			});

			$('.btn.export-show').mousedown(function() {
				var textarea = $(this).parents('.export').find('textarea');
				var matches = textarea.text().match(/\[img\]([^\[]*)\[\/img]/);
				$(this).attr('href', matches[1]);
			});
		});
	</script>
<?php endif ?>
