<?php iterateUsers(function($user, $otherUser) { ?>
<div class="section basic">
	<h2>
		<?php echo ChibiRegistry::getHelper('mg')->headerLink($user, 'profile', true) ?>
		<span class="updated" data-tooltip="Time of last data update">
			<!--<?php $diff = time() - $user->getGenerationTime() ?>
			<?php if ($diff < 60): ?>
				just now
			<?php elseif ($diff < 3600): ?>
				<?php echo ceil($diff / 60) ?> minutes ago
			<?php elseif ($diff < 24 * 3600): ?>
				<?php echo ceil($diff / 3660) ?> hours ago
			<?php else: ?>
				<?php echo sprintf('%.01f', $diff / 86400) ?> days ago
			<?php endif ?>
			&nbsp;(--><?php echo date('M d, H:i', $user->getGenerationTime()) ?> UTC<!--)-->
		</span>
		<div class="clear"></div><!-- fix for small pages -->
	</h2>

	<div class="section-body">
		<dl>

			<dt>Gender</dt>
			<?php if (!$user->isAnonymous()): ?>
				<?php if ($user->getUserData()->getGender() == UserData::GENDER_FEMALE): ?>
					<dd>Female</dd>
				<?php elseif ($user->getUserData()->getGender() == UserData::GENDER_MALE): ?>
					<dd>Male</dd>
				<?php else: ?>
					<dd>Unknown</dd>
				<?php endif ?>
			<?php else: ?>
				<dd>Unknown</dd>
			<?php endif ?>

			<dt>List views</dt>
			<dd class="list-views">
				<?php echo $user->getList(AMModel::TYPE_ANIME)->getViewCount() + $user->getList(AMModel::TYPE_MANGA)->getViewCount() ?>&nbsp;
				<span class="suffix">(
					<span data-tooltip="Anime list view count"><?php echo $user->getList(AMModel::TYPE_ANIME)->getViewCount() ?></span>
					+
					<span data-tooltip="Manga list view count"><?php echo $user->getList(AMModel::TYPE_MANGA)->getViewCount() ?></span>
				)</span>
			</dd>

			<dt>Time on MAL</dt>
			<?php if (intval($user->getUserData()->getJoinDate())): ?>
				<?php
					list ($year, $month, $day) = explode ('-', $user->getUserData()->getJoinDate());
					$time = mktime(0, 0, 0, $month, $day, $year);
					$diff = time() - $time;
					$diff /= 3600 * 24;
				?>
				<dd><?php printf('%.1f', $diff / 361.25) ?> years</dd>
			<?php else: ?>
				<dd>Unknown</dd>
			<?php endif ?>

		</dl>

		<ul class="mal-links">
			<?php if ($user->isAnonymous()): ?>
				<li>
					<a href="#">
						<i class="icon-pop-out"></i>
						MAL profile
					</a>
				</li>
				<li>
					<a href="#">
						<i class="icon-pop-out"></i>
						MAL anime list
					</a>
				</li>
				<li>
					<a href="#">
						<i class="icon-pop-out"></i>
						MAL manga list
					</a>
				</li>

			<?php else: ?>
				<li>
					<a href="http://myanimelist.net/profile/<?php echo $user->getUserName() ?>">
						<i class="icon-pop-out"></i>
						MAL profile
					</a>
				</li>
				<li>
					<a href="http://myanimelist.net/animelist/<?php echo $user->getUserName() ?>">
						<i class="icon-pop-out"></i>
						MAL anime list
					</a>
				</li>
				<li>
					<a href="http://myanimelist.net/mangalist/<?php echo $user->getUserName() ?>">
						<i class="icon-pop-out"></i>
						MAL manga list
					</a>
				</li>
			<?php endif ?>
		</ul>

	</div>
	<div class="clear"></div>
</div>
<?php }); ?>



<?php foreach (AMModel::getTypes() as $type): ?>
	<?php iterateUsers(function($user, $otherUser) use ($type) { ?>
	<?php $profileInfo = $this->profileInfo[$user->getRuntimeID()][$type] ?>
	<div class="section sub-stats" data-am="<?php echo ChibiRegistry::getHelper('mg')->textAM($type) ?>">
		<h2><?php echo ChibiRegistry::getHelper('mg')->headerLink($user, ChibiRegistry::getHelper('mg')->textAM($type) . ' summary') ?></h2>
		<div class="section-body">
			<?php if ($profileInfo->completed > 0): ?>
				<div class="wrapper-target">
					<div class="target"></div>
					<div class="clear"></div>
				</div>

				<script type="text/javascript">
					$('#user-<?php echo $user->getRuntimeID() ?> .sub-stats[data-am=\'<?php echo ChibiRegistry::getHelper('mg')->textAM($type) ?>\'] .target').each(function() {
						var chart = new Highcharts.Chart({
							chart: { renderTo: this, spacingTop: 0, spacingBottom: 0, spacingLeft: 0, spacingRight: 0 },
							yAxis: { title: { text: 'Count' } },
							plotOptions: {
								pie: {
									size: '100%', shadow: false,
									dataLabels: { enabled: true, formatter: function() { return this.percentage < 10 ? '' : this.key; }, distance: -30, color: 'white' },
							} },
							tooltip: { formatter: function() {
								var text = this.key + ': ' + this.y;
								var percent = this.y * 100.0 / <?php echo max(1, $profileInfo->subTypeDistribution->getTotalSize()) ?>;
								text = text + ' (' + (Math.round(percent * 100.0) / 100.0) + '%)';
								return text;
							} },
							series: [ {
								type: 'pie',
								data: <?php echo json_encode(array_map(function($key) use ($profileInfo) { return ['name' => ucfirst(ChibiRegistry::getHelper('mg')->textSubType($key)), 'category' => $key, 'y' => $profileInfo->subTypeDistribution->getGroupSize($key)]; }, $profileInfo->subTypeDistribution->getGroupsKeys())) ?>,
								point: { events: { click: function(e) {
									var am = $(e.target).parents('.sub-stats').attr('data-am');
									toggleMoreWrappers($('.sub-stats[data-am=\'' + am + '\'] .wrapper-more'), {'sender': 'sub-type', 'sub-type': this.category, 'am': am});
								} } }
							} ]
						});
					});
				</script>
			<?php endif ?>

			<dl>
				<dt>Completed</dt>
				<dd><?php echo $profileInfo->completed ?></dd>

				<dt>Franchises</dt>
				<dd><?php echo count($profileInfo->franchises) ?> <a class="franchises" href="#">(show full list)</a></dd>

				<?php if ($type == AMModel::TYPE_ANIME): ?>
					<dt>Episodes</dt>
				<?php elseif ($type == AMModel::TYPE_MANGA): ?>
					<dt>Chapters</dt>
				<?php endif ?>
				<dd>
					<?php echo $profileInfo->eps ?>
					<?php if (!empty($profileInfo->epsMismatched)): ?>
						&nbsp;<a class="mismatched-eps" href="#">(mismatch!)</a>
					<?php endif ?>
				</dd>

				<dt>Mean score</dt>
				<dd>
					<?php if ($profileInfo->scoreDistribution->getRatedCount() == 0): ?>
						-
					<?php else: ?>
						<?php printf('%.02f', $profileInfo->scoreDistribution->getMeanScore()) ?>
					<?php endif ?>
				</dd>
			</dl>

			<p>You've&#32;
				<?php if ($type == AMModel::TYPE_ANIME): ?>
					watched
				<?php elseif ($type == AMModel::TYPE_MANGA): ?>
					read
				<?php endif ?>&#32;
				<?php $diff = $profileInfo->scoreDistribution->getMeanScore() - $this->globalInfo->getAMData($type)->getScoreDistribution()->getMeanScore() ?>
				<strong><?php printf('%.02f', $profileInfo->completed * 100.0 / max(1, $this->globalInfo->getAMData($type)->getDBSize())) ?>%</strong> of all <?php echo ChibiRegistry::getHelper('mg')->textAM($type) ?> on MAL
				<?php if ($profileInfo->scoreDistribution->getRatedCount() > 0): ?>
					&#32;and your ratings are <strong><?php printf('%.02f', abs($diff)) ?></strong> points <strong><?php echo $diff < 0 ? 'lower' : 'higher' ?></strong> than global average.
				<?php else: ?>
					.
				<?php endif ?>
			</p>

			<?php if ($profileInfo->completed > 0 and $profileInfo->lengthDistribution->getLargestGroupSize() > 0 /* only titles of unknown length */): ?>
				<p>
					Most common&#32;
					<?php if ($type == AMModel::TYPE_ANIME): ?>
						TV series length:&nbsp;
						<?php echo ChibiRegistry::getHelper('mg')->textEpisodes(str_replace('-', '&nbsp;to&nbsp;', $profileInfo->lengthDistribution->getLargestGroupKey()), false, '<strong>%s</strong> %s') ?>
					<?php elseif ($type == AMModel::TYPE_MANGA): ?>
						manga length:&nbsp;
						<?php echo ChibiRegistry::getHelper('mg')->textChapters(str_replace('-', '&nbsp;to&nbsp;', $profileInfo->lengthDistribution->getLargestGroupKey()), false, '<strong>%s</strong> %s') ?>
					<?php endif ?>&#32;
				</p>
			<?php endif ?>

			<div class="clear"></div>
		</div>
	</div>
	<?php }); ?>
	<?php iterateUsers(function($user, $otherUser) use ($type) { ?>
	<div class="section sub-stats" data-am="<?php echo ChibiRegistry::getHelper('mg')->textAM($type) ?>">
		<div class="wrapper-more">
		</div>
	</div>
	<?php }); ?>
<?php endforeach ?>



<?php iterateUsers(function($user, $otherUser) { ?>
<div class="section friends">
	<h2><?php echo ChibiRegistry::getHelper('mg')->headerLink($user, 'friends (' . count($user->getFriends()) . ')') ?></h2>
	<div class="section-body">
		<?php if ($user->isAnonymous()): ?>
			<p>This user wanted to be anonymous, so their friends aren&rsquo;t shown.</p>
		<?php elseif (count($user->getFriends()) == 0): ?>
			<p>This user has no friends on MAL. :(</p>
		<?php else: ?>
			<div class="scrollable">
				<?php $friends = $user->getFriends() ?>
				<?php usort($friends, function($a, $b) { return strlen($a->getName()) > strlen($b->getName()); }) ?>
				<ul>
					<?php foreach ($friends as $friend): ?>
						<li>
							<a class="mg waitable" href="<?php echo ChibiRegistry::getHelper('mg')->constructUrl(null, null, [], [reset($this->userNames), $friend->getName()]) ?>">
								<i class="icon-mg"></i>
								<span><?php echo $friend->getName() ?></span>
							</a>
						</li>
					<?php endforeach ?>
				</ul>
				<div class="clear"></div>
			</div>
		<?php endif ?>
	</div>
</div>
<?php }); ?>



<?php iterateUsers(function($user, $otherUser) { ?>
<div class="section clubs">
	<h2><?php echo ChibiRegistry::getHelper('mg')->headerLink($user, 'clubs (' . count($user->getClubs())  . ')') ?></h2>
	<div class="section-body">
		<?php if ($user->isAnonymous()): ?>
			<p>Neither will we tell you their clubs.</p>
		<?php elseif (count($user->getClubs()) == 0): ?>
			<p>This user doesn&rsquo;t belong to any clubs.</p>
		<?php else: ?>
			<div class="scrollable">
				<?php $clubs = $user->getClubs() ?>
				<?php usort($clubs, function($a, $b) { return strlen($a->getName()) > strlen($b->getName()); }) ?>
				<ul>
					<?php foreach ($clubs as $club): ?>
						<li>
							<a href="http://myanimelist.net/clubs.php?cid=<?php echo $club->getID() ?>">
								<i class="icon-club"></i>
								<span><?php echo $club->getName() ?></span>
							</a>
						</li>
					<?php endforeach ?>
				</ul>
				<div class="clear"></div>
			</div>
		<?php endif ?>
	</div>
</div>
<?php }); ?>



<script type="text/javascript">
	$('.franchises, .mismatched-eps').click(function(e) {
		var sender = $(this).attr('class');
		var am = $(this).parents('.sub-stats').attr('data-am');
		toggleMoreWrappers($('.sub-stats[data-am=\'' + am + '\'] .wrapper-more'), {'sender': sender, 'am': am});
		e.preventDefault();
	});
</script>
