<?php $u = $this->user ?>
<div class="section">
	<h2>
		<a href="<?php echo $this->mgHelper->constructUrl(null, null, [], $u['link-name']) ?>">
			<?php echo $u['visible-name'] ?>
		</a>
		`s <?php echo $this->am ?> activity
	</h2>
</div>

<div class="section acti-line-daily">
	<h3>
		<i data-title="Number of titles you've completed within given day. Shows last three weeks with 24h accuracy." class="tooltipable icon-tooltip"></i>
		Activity timeline (daily)
	</h3>
	<div class="section-body">
		<ul class="infobox">
			<li>
				<div>
					<span class="prefix">Total time</span>
					<span class="subject"><?php printf('%.02f', $u[$this->am]['acti-info']['total-duration'] / 60.0 / 24.0) ?></span>
					<span class="suffix">days</span>
				</div>
			</li>
			<li>
				<div>
					<span class="prefix">Average time</span>
					<span class="subject"><?php printf('%.02f', $u[$this->am]['acti-info']['mean-time']) ?></span>
					<span class="suffix">min/day</span>
				</div>
			</li>
		</ul>

		<div class="wrapper wrapper-target">
			<div class="target"></div>
			<div class="clear"></div>
		</div>

		<div class="wrapper wrapper-more">
			<?php foreach ($u[$this->am]['acti-info']['day-periods'] as $k => $dp): ?>
				<div class="more" data-id="<?php echo $k ?>">
					<?php if ($k == 0): ?>
						<p>Titles from today:</p>
					<?php elseif ($k == 1): ?>
						<p>Titles from yesterday:</p>
					<?php else: ?>
						<p>Titles from <?php echo $k ?> days ago:</p>
					<?php endif ?>
					<ul>
						<?php foreach ($dp['titles'] as $e): ?>
							<li>
								<a href="http://myanimelist.net/<?php echo $this->mgHelper->amText() ?>/<?php echo $e['full']['id'] ?>">
									<?php echo $e['full']['title'] ?>
								</a>
								&nbsp;&ndash;&nbsp;
								<?php if ($this->am == AMModel::ENTRY_TYPE_MANGA): ?>
									chap. <?php echo $e['user']['chap'] ?>
								<?php else: ?>
									ep. <?php echo $e['user']['ep'] ?>
								<?php endif ?>
							</li>
						<?php endforeach ?>
					</ul>
				</div>
			<?php endforeach ?>
		</div>

		<script type="text/javascript">
			$('#user-<?php echo $u['user-id'] ?> .acti-line-daily .target').each(function() {
				var chart = new Highcharts.Chart({
					chart: { renderTo: this, type: 'column', marginTop: 8 },
					xAxis: { categories: <?php echo json_encode(array_map(function($x) { return sprintf('%02d', $x); }, array_keys($u[$this->am]['acti-info']['day-periods']))) ?>, title: { text: 'Days ago', margin: 15 }, labels: { style: { fontSize: '10px !important' } } },
					yAxis: { title: { text: 'Count' }, min: 0 },
					tooltip: { formatter: function() {
						var text = '<?php echo $this->am == AMModel::ENTRY_TYPE_MANGA ? 'Chapters' : 'Epsidoes' ?> completed ';
						if (this.x == 0) {
							text += 'today';
						} else if (this.x == 1) {
							text += 'yesterday';
						} else {
							text += this.x + ' days ago';
						}
						text += ': ' + this.y;
						return text; } },
					series: [ {
						data: <?php echo json_encode(array_map(function($p) { return count($p['titles']); }, array_values($u[$this->am]['acti-info']['day-periods']))) ?>,
						point: { events: { click: function(e) {
							var target = $('#user-<?php echo $u['user-id'] ?> .acti-line-daily .more[data-id=' + this.x + ']');
							if (!target.is(':visible')) {
								$('#user-<?php echo $u['user-id'] ?> .acti-line-daily .wrapper .more').hide('slow');
								target.show('slow', function() { stopResizingSections(); });
							} else {
								target.hide('slow', function() { stopResizingSections(); });
							}
							startResizingSections();
						} } }
					} ],
					plotOptions: { column: { pointWidth: 17 } }
				});
			});
		</script>
	</div>
</div>

<div class="section acti-line-monthly">
	<h3>
		<i data-title="Number of titles you've completed within given month." class="tooltipable icon-tooltip"></i>
		Activity timeline (monthly)
	</h3>
	<div class="section-body">
		<?php if (empty($u[$this->view->am]['acti-info']['month-periods'])): ?>
			<p>No <?php echo $this->mgHelper->amText() ?> you've completed has its completion date specified. This graph won't work without this data.</p>
		<?php elseif (count($u[$this->view->am]['acti-info']['month-periods']) == 1): ?>
			<p>You completed <?php echo $this->mgHelper->amText() ?> from only period and that is <?php echo reset(array_keys($u[$this->am]['acti-info']['month-periods'])) ?>, so a graph isn't needed.</p>
		<?php else: ?>
			<div class="wrapper wrapper-target">
				<div style="width: <?php echo count($u[$this->am]['acti-info']['month-periods']) * 30 + 100 ?>px" class="target"></div>
				<div class="clear"></div>
			</div>

			<div class="wrapper wrapper-more">
				<?php foreach ($u[$this->am]['acti-info']['month-periods'] as $k => $mp): ?>
					<div class="more" data-id="<?php echo $k ?>">
						<p>Titles from <?php echo $k ?>:</p>
						<ul>
							<?php foreach ($mp['titles'] as $e): ?>
								<li>
									<a href="http://myanimelist.net/<?php echo $this->mgHelper->amText() ?>/<?php echo $e['full']['id'] ?>">
										<?php echo $e['full']['title'] ?>
									</a>
								</li>
							<?php endforeach ?>
						</ul>
					</div>
				<?php endforeach ?>
			</div>

			<script type="text/javascript">
				$('#user-<?php echo $u['user-id'] ?> .acti-line-monthly .target').each(function() {
					var chart = new Highcharts.Chart({
						chart: { renderTo: this, type: 'line', marginTop: 8, marginBottom: 56 },
						xAxis: { categories: <?php echo json_encode(array_keys($u[$this->am]['acti-info']['month-periods'])) ?>, labels: { rotation: -45, align: 'right' } },
						yAxis: { title: {text: 'Count'}, min: 0 },
						tooltip: { formatter: function() { var text = 'Titles from ' + this.x + ': ' + this.y; return text; } },
						series: [ {
							data: <?php echo json_encode(array_map(function($p) { return count($p['titles']); }, array_values($u[$this->am]['acti-info']['month-periods']))) ?>,
							point: { events: { click: function(e) {
								var target = $('#user-<?php echo $u['user-id'] ?> .acti-line-monthly .more[data-id=\'' + this.category + '\']');
								if (!target.is(':visible')) {
									$('#user-<?php echo $u['user-id'] ?> .acti-line-monthly .wrapper .more').hide('slow');
									target.show('slow', function() { stopResizingSections(); });
								} else {
									target.hide('slow', function() { stopResizingSections(); });
								}
								startResizingSections();
							} } }
						} ],
					});
					});
				$('.acti-line-monthly .wrapper-target').jScrollPane();
			</script>
		<?php endif ?>

	</div>
</div>

<div class="section omitted">
	<h3>
		<i data-title="Titles that have missing start or completion date." class="tooltipable icon-tooltip"></i>
		Titles with unknown completion date
		<?php if (!empty($u[$this->view->am]['acti-info']['omitted-titles'])): ?>
			&nbsp;(<?php echo count($u[$this->view->am]['acti-info']['omitted-titles']) ?>)
		<?php endif ?>
	</h3>
	<div class="section-body">
		<?php if (empty($u[$this->view->am]['acti-info']['omitted-titles'])): ?>
			<p>Hurrah! No title has unspecified completion nor start date.</p>
		<?php else: ?>
			<table>
				<thead>
					<tr>
						<th class="ord">#</th>
						<?php echo $this->htmlHelper->tableHeadStatus() ?>
						<?php echo $this->htmlHelper->tableHeadTitle() ?>
						<?php echo $this->htmlHelper->tableHeadStartDate() ?>
						<?php echo $this->htmlHelper->tableHeadFinishDate() ?>
					</tr>
				</thead>

				<tbody>
					<?php $k = 1 ?>
					<?php foreach ($u[$this->view->am]['acti-info']['omitted-titles'] as $e): ?>
						<tr>
							<td class="ord"><?php echo $k ++ ?></td>
							<?php echo $this->htmlHelper->tableBodyStatus($e) ?>
							<?php echo $this->htmlHelper->tableBodyTitle($e) ?>
							<?php echo $this->htmlHelper->tableBodyStartDate($e) ?>
							<?php echo $this->htmlHelper->tableBodyFinishDate($e) ?>
						</tr>
					<?php endforeach ?>
				</tbody>

			</table>
		<?php endif ?>
	</div>
</div>
